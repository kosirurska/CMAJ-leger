---
title: "Psychological distress during COVID-19 in Canadian youth with and without chronic health conditions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load the libraries
library(tidyverse)
library(readr)
library(here)
library(psych)
library(english)
library(stringr)
library(tableone)
library(kableExtra)
library(scales)
library(ggridges)
library(plotly)
library(patchwork)
library(haven)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(table1)
library(rstatix)
library(car)
library(multcomp)
#library(compute.se)
library(effects)
library(pastecs)
#library(WRS)
```

```{r data, echo=FALSE, message=FALSE, warning=FALSE}
# Read in the clean csv file
leger <- read_csv("data/cmaj_analyses.csv")

# subset for chronic people only
leger_chronic <- leger %>%
  filter(chronic_dummy == 1)

# Data for the plot
marginal_means <- read_csv("data/marginal_means.csv")

marginal_means_2 <- read_csv("data/marginal_means2.csv")

covid_cases <- read_csv("data/covid19-download.csv")

# set seed for all analyses and wrangling
set.seed(1)
```

#### Aims:
Using Canadian representative samples, we aimed 

1) Report any differences in psychological functioning (feelings of anxiety, depression, loneliness, anger/frustration)  among young people with different medical needs, and see how it changed over the course of the pandemic;

2) compare young people with any chronic health condition to their healthy peers in terms of COVID-19 impact on psychological functioning.

## METHOD

The present study is part of a larger International COVID‐19 Awareness and Responses Evaluation (iCARE) study, which is a global multi‐phase research survey conducted through the Montreal Behavioural Medicine Centre. Find more about the study and materials at [www.iCAREstudy.com](www.iCAREstudy.com). 

## RESULTS
### Sample

```{r echo=FALSE, warning=FALSE}
table_data <- leger %>%
  dplyr::select(age_yrs, sex, edu, hoinc, province_full, chronic_descriptive, chronic_dummy, chronic_multi, any_m_health, distress_sum, vaccine, booster_dummy) %>%
  mutate(chronic_dummy = factor(chronic_dummy,
                                levels = c(0:1),
                                labels = c("Healthy", "Chronic Health Condition")),
         chronic_multi = factor(chronic_multi, 
                                levels = c(0:1),
                                labels = c("No", "Yes")),
         any_m_health = factor(any_m_health,
                               levels = c(0:1),
                               labels = c("No", "Yes")))

label(table_data$sex) <- "Sex"
label(table_data$age_yrs) <- "Age"
label(table_data$edu) <- "Education"
label(table_data$province_full) <- "Province"
label(table_data$hoinc) <- "Income"
label(table_data$chronic_descriptive) <- "Chronic illness"
label(table_data$chronic_multi) <- "Multimorbidity"
label(table_data$any_m_health) <- "Diagnosis of mental health disorder"
label(table_data$distress_sum) <- "COVID-19 distress"
label(table_data$vaccine) <- "Received COVID-19 vaccine?"
label(table_data$booster_dummy) <- "Likelihood of taking COVID-19 booster dose?"

units(table_data$age_yrs) <- "years"

table1(~ age_yrs + sex + edu + hoinc + province_full + chronic_descriptive + chronic_multi + any_m_health + distress_sum + vaccine + booster_dummy | chronic_dummy,
       data = table_data)

```

### COVID-19 related psychological distress over time

```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width= 10, fig.height=8}
# A<-leger %>%
#   dplyr::select(chronic_dummy, wave, distress_sum, sex) %>%
#   #filter(sex %in% c("Female", "Male")) %>%
#   mutate(chronic_dummy = factor(chronic_dummy,
#                                 levels = c(0:1),
#                                 labels = c("No", "Yes")),
#          wave = as.factor(wave)) %>%
#   ggplot(aes(x = wave)) +
#   geom_boxplot(aes(y = distress_sum, fill=chronic_dummy)) +
#   labs(title = "", x = " ", y = "Level of psychological distress", fill = "Chronic condition",
#        caption = "Distress was significantly different across time only in individuals with no chronic health conditions. \nThe p-values demonstrate the survey rounds that were significanlty different than the first point (2). Numbers in brackets stand for the survey wave.") +
#   ylim(0, 13) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   geom_text(label = "Ref.", x = 0.8, y = 12.5, size = 2.5) +
#   geom_text(label = "** \np = 0.001", x = 1.8, y = 12.5, size = 2.5) +
#   geom_text(label = "*** \np < 0.001", x = 2.8, y = 12.5, size = 2.5) +
#   geom_text(label = "*** \np < 0.001", x = 3.8, y = 12.5, size = 2.5) +
#   scale_x_discrete(breaks = c(2, 3, 4, 5, 6, 7),
#                      labels = c("Mid June \n2020 \n(2)", "Early Nov. \n2020 \n(3)", "Late Jan. \n2021 \n(4)",
#                                 "Late March \n2021 \n(5)", "Early June \n2021 \n(6)", "Mid Sept. \n2021 \n(7)"))

# This is boxplots by mental health diagnosis over time
# leger %>%
#   dplyr::select(chronic_dummy, wave, distress_sum, sex, any_m_health) %>%
#   filter(sex %in% c("Female", "Male")) %>%
#   mutate(chronic_dummy = factor(chronic_dummy,
#                                 levels = c(0:1),
#                                 labels = c("No", "Yes")),
#          any_m_health = factor(any_m_health,
#                                levels = c(0:1),
#                                 labels = c("No", "Yes")),
#          wave = as.factor(wave)) %>%
#   ggplot(aes(x = wave)) +
#   geom_boxplot(aes(y = distress_sum, fill=chronic_dummy)) +
#   #facet_wrap(~chronic_dummy) +
#   labs(title = " ", x = "Survey round", y = "Level of psychological distress", fill = "Chronic condition") +
#   facet_wrap(~any_m_health, ncol = 2) +
#   ylim(0, 13) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   scale_x_discrete(breaks = c(2, 3, 4, 5, 6, 7),
#                      labels = c("Mid June \n2020 \n(2)", "Early Nov. \n2020 \n(3)", "Late Jan. \n2021 \n(4)",
#                                 "Late March \n2021 \n(5)", "Early June \n2021 \n(6)", "Mid Sept. \n2021 \n(7)"))
# 
# # 
# GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
#                            draw_group = function(self, data, ..., draw_quantiles = NULL) {
#   data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
#   grp <- data[1, "group"]
#   newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
#   newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
#   newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])
# 
#   if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
#     stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
#       1))
#     quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
#     aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
#     aesthetics$alpha <- rep(1, nrow(quantiles))
#     both <- cbind(quantiles, aesthetics)
#     quantile_grob <- GeomPath$draw_panel(both, ...)
#     ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
#   }
#   else {
#     ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
#   }
# })
# 
# geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
#                               draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
#                               show.legend = NA, inherit.aes = TRUE) {
#   layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
#         position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
#         params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
# }
# 
# leger %>%
#   dplyr::select(chronic_dummy, wave, distress_sum, sex) %>%
#   filter(sex %in% c("Female", "Male")) %>%
#   mutate(m = factor(chronic_dummy,
#                                 levels = c(0:1),
#                                 labels = c("No", "Yes")),
#          x = as.factor(wave),
#          y = distress_sum) %>%
#   ggplot(aes(x, y, fill = m)) +
#   geom_split_violin() +
#   labs(title = "Split violin (density) plot", x = "Survey round", y = "Level of psychological distress", fill = "Chronic condition") +
#   #facet_grid(~sex) +
#   ylim(0, 12) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   scale_x_discrete(breaks = c(2, 3, 4, 5, 6, 7),
#                      labels = c("Mid June \n2020 \n(2)", "Early Nov. \n2020 \n(3)", "Late Jan. \n2021 \n(4)",
#                                 "Late March \n2021 \n(5)", "Early June \n2021 \n(6)", "Mid Sept. \n2021 \n(7)"))

## PLOT CASES
B<-covid_cases %>%
  filter(date > "2020-06-01") %>% 
  filter(date < "2021-09-30") %>%
  ggplot(aes(x = date, y = numtoday, fill = numtoday)) +
  geom_line(color = "light blue") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_x_date(date_labels = "%b %d", date_breaks = "1 month") +
  labs(x = "Time", y = "Number of COVID-19 cases")

D<-marginal_means %>%
  mutate(chronic_dummy = factor(chronic_dummy,
                                levels = c(0:1),
                                labels = c("No", "Yes")),
         wave = as.factor(wave)) %>%
  ggplot(aes(x = wave, y = mean, color = chronic_dummy)) + 
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="black", width=.1) +
  labs(title = "", x = " ", y = "Marginal mean of psychological distress", color = "Chronic condition"
       # caption = "Distress was significantly different across time only in individuals with no chronic health conditions. \nThe p-values demonstrate the survey rounds that were significanlty different than the first point (2). Numbers in brackets stand for the survey wave."
       ) +
  ylim(4, 9) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_text(label = "Ref.", x = 1, y = 5.3, size = 2.5, show.legend = FALSE) +
  geom_text(label = "** \np = 0.001", x = 2, y = 5.5, size = 2.5, show.legend = FALSE) +
  geom_text(label = "*** \np < 0.001", x = 3, y = 5.5, size = 2.5, show.legend = FALSE) +
  geom_text(label = "*** \np < 0.001", x = 4, y = 5.5, size = 2.5, show.legend = FALSE) +
  scale_x_discrete(breaks = c(2, 3, 4, 5, 6, 7),
                   labels = c("Mid June \n2020 \n(2)", "Early Nov. \n2020 \n(3)", "Late Jan. \n2021 \n(4)",
                              "Late March \n2021 \n(5)", "Early June \n2021 \n(6)", "Mid Sept. \n2021 \n(7)"))


E <- marginal_means_2 %>%
  mutate(chronic_dummy = factor(chronic_dummy,
                                levels = c(0:1),
                                labels = c("No", "Yes")),
         wave = as.factor(wave)) %>%
  ggplot(aes(x = wave, y = mean, color = chronic_dummy)) + 
  geom_point(size = 3) +
  geom_errorbar(aes(ymin=lower, ymax=upper), colour="black", width=.1) +
  labs(title = "", x = " ", y = "Marginal mean of psychological distress", color = "Chronic condition") +
  ylim(4.8, 9) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)
        #legend.position = c(0.92, 0.89) ## if want to adjust the location of the legend
        ) +
  geom_text(label = "Ref.", x = 1, y = 5.4, size = 2.5, show.legend = FALSE) +
  geom_text(label = "** \np = 0.001", x = 2, y = 5.5, size = 2.5, show.legend = FALSE) +
  geom_text(label = "*** \np < 0.001", x = 3, y = 5.5, size = 2.5, show.legend = FALSE) +
  geom_text(label = "*** \np < 0.001", x = 4, y = 5.5, size = 2.5, show.legend = FALSE) +
    geom_text(label = "** \np = 0.002", x = 1, y = 8.8, size = 2.5, show.legend = FALSE, color = "black") +
  geom_text(label = "** \np = 0.001", x = 3, y = 8.8, size = 2.5, show.legend = FALSE, color = "black") +
  geom_text(label = ". \np = 0.054", x = 5, y = 8.8, size = 2.5, show.legend = FALSE, color = "black") +
  geom_text(label = "** \np = 0.006", x = 6, y = 8.8, size = 2.5, show.legend = FALSE, color = "black") +

  scale_x_discrete(breaks = c(2, 3, 4, 5, 6, 7),
                   labels = c("Mid June \n2020 \n(2)", "Early Nov. \n2020 \n(3)", "Late Jan. \n2021 \n(4)",
                              "Late March \n2021 \n(5)", "Early June \n2021 \n(6)", "Mid Sept. \n2021 \n(7)"))

#D + E + plot_annotation(tag_levels = 'A')
```

```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width= 10, fig.height=11}
#fig.width= 12, fig.height=14
# (D/B) + plot_annotation(tag_levels = 'A')

#  facet_zoom(ylim = c(5.5, 9.5), zoom.data = ifelse(mean <= 9, NA, FALSE))
# library(ggforce)
(E/B) + plot_annotation(tag_levels = 'A')
```

### Within-group comparisons over time, adjusted for age & sex

#### Chronic health conditions over time
```{r echo=FALSE, warning=FALSE, message=FALSE}
chronic <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, hoinc, chronic_dummy, any_m_health, wave) %>%
  filter(chronic_dummy == 1)%>%
  mutate(wave = factor(wave, ordered = TRUE))

# Levene's test for homogeneity of variance
levene_test(chronic, distress_sum ~ wave)

# ANCOVA
m1 = aov(distress_sum ~ wave + sex + age_yrs + any_m_health, data = chronic)

Anova(m1, type="III")

# To get adjusted or marginal means
# m1_adjusted <- effect("wave", m1, se=TRUE)
# m1_adjusted$se
# summary(m1_adjusted)


# m1_posthoc <- glht(m1, linfct = mcp(wave = "Tukey"))
# summary(m1_posthoc)
```

#### Healthy over time
```{r echo=FALSE, warning=FALSE, message=FALSE}
healthy <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, hoinc, chronic_dummy, any_m_health, wave) %>%
  filter(chronic_dummy == 0)%>%
  mutate(wave = factor(wave, ordered = TRUE))

# Leven's test
levene_test(healthy, distress_sum ~ wave)

# ANCOVA
m2 = aov(distress_sum ~ wave + sex + age_yrs + any_m_health, data = healthy)

Anova(m2, type="III")

m2_posthoc <- glht(m2, linfct = mcp(wave = "Tukey"))
summary(m2_posthoc)

# To get adjusted or marginal means
# m2_adjusted <- effect("wave", m2, se=TRUE)
# m2_adjusted$se
# 
# summary(m2_adjusted)

# Calculate effect sizes
# 
# summary.lm(m2)
# 
# t <- c(-0.417, -7.348, 0.919, 0.766, 1.682, -13.287, -10.7049, 15.372)
# df <- 4380
# 
# sqrt((t^2)/(t^2+df))

```

### DISTRESS WOMEN with chronic health v. no chronic health at each survey wave -->

In short - significant differences occur at waves: 2,4,6*not quite,7

Calculate effect sizes for chronic at each sig time point
```{r}
# Calculate effect sizes
# 
# summary.lm(w7_m1)
# 
t2 <- c(3.190)
df2 <- 1066
t4 <- c(1.781)
df4 <- 1003
t6 <- c(2.435)
df6<- 931
t7 <- c(7.227)
df7<-922

# 
sqrt((t2^2)/(t2^2+df2))
sqrt((t4^2)/(t4^2+df4))
sqrt((t6^2)/(t6^2+df6))
sqrt((t7^2)/(t7^2+df7))

```

#### wave 2
```{r echo=FALSE}
w2 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 2)
  
w2_m1 = aov(distress_sum ~ chronic_dummy + age_yrs + any_m_health, data = w2)

Anova(w2_m1, type="III")
```
#### wave 3
```{r echo=FALSE}
w3 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 3)

w3_m1 = aov(distress_sum ~ chronic_dummy + age_yrs + any_m_health, data = w3)

Anova(w3_m1, type="III")
```
#### wave 4
```{r echo=FALSE}
w4 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 4)

w4_m1 = aov(distress_sum ~ chronic_dummy + age_yrs + any_m_health, data = w4)

Anova(w4_m1, type="III")
```
#### wave 5
```{r echo=FALSE}
w5 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 5)

w5_m1 = aov(distress_sum ~ chronic_dummy + age_yrs + any_m_health, data = w5)

Anova(w5_m1, type="III")  
```
#### wave 6
```{r echo=FALSE}
w6 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 6)

w6_m1 = aov(distress_sum ~ chronic_dummy + age_yrs +any_m_health, data = w6)

Anova(w6_m1, type="III")   
```
#### wave 7
```{r echo=FALSE}
w7 <- leger %>%
  dplyr::select(distress_sum, sex, age_yrs, any_m_health, chronic_dummy, wave) %>%
  filter(wave == 7)

w7_m1 = aov(distress_sum ~ chronic_dummy + age_yrs + any_m_health, data = w7)

Anova(w7_m1, type="III")  
```

## DISCUSSION

For now, see the project log.
